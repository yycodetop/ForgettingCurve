<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>艾宾浩斯智能学伴 Pro Max Ultra++++</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen overflow-hidden font-sans selection:bg-indigo-100">

    <div id="app" class="h-full flex" v-cloak>
        
        <!-- 左侧：数据激励 + 科目管理 -->
        <aside class="w-72 bg-slate-900 text-white flex flex-col shadow-2xl z-20 shrink-0">
            <!-- Logo -->
            <div class="p-6 border-b border-slate-800 flex items-center gap-3 shrink-0">
                <div class="w-10 h-10 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center shadow-lg hover:scale-105 transition">
                    <i class="fas fa-rocket text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-wide">超级学霸</h1>
                    <p class="text-xs text-slate-400">数据驱动学习 v11.0</p>
                </div>
            </div>

            <!-- 滚动区域 -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- 核心统计 -->
                <div class="p-6 space-y-6">
                    <div class="bg-slate-800 rounded-2xl p-4 text-center border border-slate-700 relative overflow-hidden group cursor-default">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500"></div>
                        <div class="text-slate-400 text-xs uppercase font-bold mb-1">累计获得 SSS 徽章</div>
                        <div class="text-5xl font-black text-yellow-400 drop-shadow-lg group-hover:scale-110 transition-transform duration-300">
                            {{ stats.sssCount }}
                        </div>
                        <div class="text-xs text-slate-500 mt-2">完美记忆大师</div>
                    </div>

                    <!-- 质量分布 -->
                    <div class="space-y-3">
                        <h3 class="text-xs font-bold text-slate-500 uppercase">质量分布</h3>
                        <div class="flex items-center gap-3 bg-slate-800/50 p-2 rounded-lg group hover:bg-slate-800 transition">
                            <div class="w-8 h-8 rounded bg-yellow-500/20 text-yellow-400 flex items-center justify-center font-black text-xs border border-yellow-500/30">S3</div>
                            <div class="flex-1">
                                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-400 transition-all duration-1000" :style="{width: stats.sssRate + '%'}"></div>
                                </div>
                            </div>
                            <span class="text-xs font-bold w-8 text-right">{{ stats.sssCount }}</span>
                        </div>
                        <div class="flex items-center gap-3 bg-slate-800/50 p-2 rounded-lg group hover:bg-slate-800 transition">
                            <div class="w-8 h-8 rounded bg-purple-500/20 text-purple-400 flex items-center justify-center font-bold text-xs border border-purple-500/30">S2</div>
                            <div class="flex-1">
                                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-purple-400 transition-all duration-1000" :style="{width: stats.ssRate + '%'}"></div>
                                </div>
                            </div>
                            <span class="text-xs font-bold w-8 text-right">{{ stats.ssCount }}</span>
                        </div>
                        <div class="flex items-center gap-3 bg-slate-800/50 p-2 rounded-lg group hover:bg-slate-800 transition">
                            <div class="w-8 h-8 rounded bg-blue-500/20 text-blue-400 flex items-center justify-center font-bold text-xs border border-blue-500/30">S1</div>
                            <div class="flex-1">
                                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-400 transition-all duration-1000" :style="{width: stats.sRate + '%'}"></div>
                                </div>
                            </div>
                            <span class="text-xs font-bold w-8 text-right">{{ stats.sCount }}</span>
                        </div>
                    </div>
                </div>

                <!-- 学科战力榜 -->
                <div class="px-6 pb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 flex justify-between items-center">
                        <span>学科战力榜</span>
                        <span class="text-[10px] bg-slate-800 px-1.5 py-0.5 rounded">截止今日</span>
                    </h3>
                    <div class="space-y-3">
                        <div v-for="sub in subjectStats" :key="sub.name" @click="openSubjectOverview(sub.name)" class="group cursor-pointer p-2 rounded-lg hover:bg-slate-800 transition border border-transparent hover:border-slate-700">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-slate-300 font-medium group-hover:text-white transition flex items-center gap-1">
                                    {{ sub.name }} <i class="fas fa-chevron-right text-[10px] opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </span>
                                <span class="font-bold" :class="getRateColor(sub.rate)">{{ sub.rate }}%</span>
                            </div>
                            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden group-hover:bg-slate-900">
                                <div class="h-full rounded-full transition-all duration-1000" :class="getRateBarColor(sub.rate)" :style="{width: sub.rate + '%'}"></div>
                            </div>
                        </div>
                        <div v-if="subjectStats.length === 0" class="text-center text-xs text-slate-600 py-2">暂无学科数据</div>
                    </div>
                </div>
            </div>
            
            <!-- 科目管理 -->
            <div class="p-5 bg-slate-950/50 border-t border-slate-800 shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-slate-400 uppercase"><i class="fas fa-tags mr-1"></i> 科目管理</h3>
                    <span class="text-[10px] text-slate-600">{{ categories.length }}个</span>
                </div>
                <div class="flex flex-wrap gap-2 mb-3 max-h-24 overflow-y-auto custom-scrollbar">
                    <div v-for="(cat, index) in categories" :key="index" class="group flex items-center gap-1 px-2 py-1 rounded bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:border-indigo-500 transition cursor-default">
                        <span>{{ cat }}</span>
                        <button @click="removeCategory(index)" class="w-4 h-4 flex items-center justify-center rounded-full hover:bg-red-500/20 hover:text-red-400 text-slate-600 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times text-[10px]"></i></button>
                    </div>
                </div>
                <div class="relative">
                    <input v-model="newCategoryName" @keyup.enter="addCategory" type="text" placeholder="输入新科目回车..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:outline-none focus:border-indigo-500 placeholder-slate-600 transition">
                    <button @click="addCategory" class="absolute right-2 top-1.5 text-slate-500 hover:text-indigo-400 transition"><i class="fas fa-plus text-xs"></i></button>
                </div>
            </div>
        </aside>

        <!-- 中间：日历主控区 -->
        <main class="flex-1 flex flex-col bg-white min-w-0 relative z-10">
            <!-- 顶部控制条 -->
            <header class="h-16 border-b border-slate-200 flex items-center justify-between px-6 bg-white sticky top-0 z-20">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="text-indigo-600 text-2xl">{{ currentYear }}</span> 年 {{ currentMonth + 1 }} 月
                    </h2>
                    <div class="flex bg-slate-100 rounded-lg p-0.5 shadow-inner">
                        <button @click="changeMonth(-1)" class="w-8 h-8 hover:bg-white hover:shadow rounded flex items-center justify-center transition text-slate-500"><i class="fas fa-chevron-left text-xs"></i></button>
                        <button @click="resetToToday" class="px-3 text-xs font-bold text-slate-600 hover:text-indigo-600 transition">今天</button>
                        <button @click="changeMonth(1)" class="w-8 h-8 hover:bg-white hover:shadow rounded flex items-center justify-center transition text-slate-500"><i class="fas fa-chevron-right text-xs"></i></button>
                    </div>
                </div>
                <button @click="openAddTaskModal" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-indigo-200 hover:-translate-y-0.5 active:translate-y-0 active:shadow-none transition">
                    <i class="fas fa-plus"></i> 布置新任务
                </button>
            </header>

            <!-- 日历网格 -->
            <div class="flex-1 flex flex-col p-4 bg-slate-50/50 overflow-hidden">
                <div class="grid grid-cols-7 mb-2">
                    <div v-for="d in ['周日','周一','周二','周三','周四','周五','周六']" class="text-center text-xs font-bold text-slate-400">{{ d }}</div>
                </div>
                <div class="grid grid-cols-7 grid-rows-6 gap-2 flex-1 min-h-0">
                    <div v-for="n in startDayOfWeek" :key="'empty-'+n" class="bg-transparent"></div>
                    <div v-for="date in calendarDays" :key="date.fullDate" @click="selectDate(date.fullDate)"
                         class="relative rounded-xl border transition-all flex flex-col group hover:shadow-lg cursor-pointer overflow-hidden"
                         :class="[ selectedDate === date.fullDate ? 'bg-white border-indigo-500 ring-2 ring-indigo-100 shadow-md z-10' : (date.tasks.length > 0 && date.pendingCount === 0 ? 'bg-emerald-50/50 border-emerald-200' : 'bg-white border-slate-200 hover:border-indigo-300') ]">
                        <div class="absolute top-2 left-2 flex flex-col gap-1">
                            <span :class="[ 'text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full transition-colors', date.isToday ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : (selectedDate === date.fullDate ? 'bg-indigo-100 text-indigo-700' : 'text-slate-500') ]">
                                {{ date.day }}
                            </span>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center pb-2 pt-6">
                            <div v-if="date.tasks.length === 0" class="text-slate-200 text-2xl font-light">-</div>
                            <div v-else-if="date.pendingCount === 0" class="flex flex-col items-center animate-fade-in">
                                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-500 shadow-sm mb-1"><i class="fas fa-crown text-xl"></i></div>
                                <span class="text-[10px] font-bold text-yellow-600 bg-yellow-50 px-1.5 rounded">All Done</span>
                            </div>
                            <div v-else class="flex flex-col items-center w-full px-3">
                                <div class="text-3xl font-black text-slate-700 leading-none mb-1">{{ date.pendingCount }}</div>
                                <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-2">待完成</div>
                                <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-indigo-500 rounded-full" :style="{width: ((date.tasks.length - date.pendingCount) / date.tasks.length * 100) + '%'}"></div></div>
                            </div>
                        </div>
                        <div v-if="date.tasks.length > 0" class="h-4 flex items-center justify-center gap-1 pb-1">
                             <div v-for="cat in date.uniqueCats" :key="cat" :class="['w-1.5 h-1.5 rounded-full shadow-sm', getCategoryColor(cat)]" :title="cat"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 右侧：详情与列表 -->
        <aside class="w-96 bg-white border-l border-slate-200 flex flex-col shadow-xl z-30 shrink-0">
            <!-- 头部 -->
            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">{{ getWeekDay(selectedDate) }}</div>
                        <h2 class="text-3xl font-black text-slate-800">{{ formatDateCN(selectedDate) }}</h2>
                    </div>
                    <div class="text-right">
                         <div class="text-3xl font-bold text-indigo-600">{{ currentDayTasks.filter(t => !t.completed).length }}</div>
                         <div class="text-[10px] text-slate-400 uppercase font-bold">待完成</div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs mb-1 font-bold text-slate-500">
                        <span>今日进度</span>
                        <span>{{ dailyProgress }}%</span>
                    </div>
                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div class="h-full bg-indigo-500 transition-all duration-500 ease-out" :style="{width: dailyProgress + '%'}"></div>
                    </div>
                </div>
            </div>

            <!-- 列表 -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div v-if="currentDayTasks.length === 0" class="h-64 flex flex-col items-center justify-center text-slate-300 select-none">
                    <i class="fas fa-mug-hot text-4xl mb-3 opacity-50"></i>
                    <p class="text-sm font-medium">本日暂无安排</p>
                    <button @click="openAddTaskModal" class="mt-4 text-xs text-indigo-500 hover:text-indigo-600 font-bold">去布置一个？</button>
                </div>

                <div v-for="item in currentDayTasks" :key="item.taskId + '-' + item.stage" 
                     class="group bg-white rounded-xl border transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5 relative"
                     :class="[ item.completed ? 'border-slate-100 opacity-80' : 'border-slate-200 border-l-4 border-l-indigo-500' ]"
                >
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-1">
                                <span :class="['text-[10px] font-bold px-2 py-0.5 rounded bg-slate-50 border', getCategoryColorText(item.category)]">{{ item.category }}</span>
                                <span v-if="item.taskType === 'weekend'" class="text-[10px] bg-purple-50 text-purple-600 border border-purple-100 font-bold px-2 py-0.5 rounded">连周</span>
                            </div>
                            <!-- 番茄钟统计展示 -->
                            <div v-if="item.pomodoroCount > 0" class="flex items-center gap-1 text-[10px] font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded border border-red-100">
                                <i class="fas fa-stopwatch"></i> {{ item.pomodoroCount }} ({{ item.totalTimeSpent }}m)
                            </div>
                            <span v-if="item.taskType === 'onetime' && !item.pomodoroCount" class="text-[10px] text-slate-300 font-bold">单次</span>
                        </div>
                        
                        <h3 class="font-bold text-slate-800 text-base mb-1 cursor-pointer hover:text-indigo-600 transition" @click="openTaskDetail(item.taskId)" :class="{'line-through text-slate-400': item.completed}">{{ item.title }}</h3>
                        
                        <p v-if="item.description" class="text-xs text-slate-400 mb-3 line-clamp-1 cursor-pointer hover:text-slate-600" @click="openTaskDetail(item.taskId)">{{ item.description }}</p>

                        <div class="flex justify-between items-end mt-2 h-8">
                            <div v-if="item.completed" class="flex items-center gap-1 animate-fade-in">
                                <span class="font-black text-sm px-2 py-0.5 rounded transform -rotate-3 inline-block shadow-sm"
                                      :class="{
                                          'bg-yellow-100 text-yellow-600 border border-yellow-200': item.quality === 'SSS',
                                          'bg-purple-100 text-purple-600 border border-purple-200': item.quality === 'SS',
                                          'bg-blue-100 text-blue-600 border border-blue-200': item.quality === 'S'
                                      }">
                                    {{ item.quality }}
                                </span>
                            </div>
                            <div v-else class="text-xs text-slate-400 flex items-center gap-1">
                                <span class="px-1.5 py-0.5 rounded font-bold"
                                      :class="[
                                        item.taskType === 'onetime' ? 'bg-slate-100 text-slate-500' : 
                                        item.taskType === 'weekend' ? 'bg-purple-50 text-purple-600' :
                                        (item.stage === 0 ? 'bg-orange-50 text-orange-600' : 'bg-indigo-50 text-indigo-600')
                                      ]">
                                    {{ item.taskType === 'onetime' ? '专项' : item.taskType === 'weekend' ? `第${item.stage + 1}周` : (item.stage === 0 ? '新学' : item.interval + '天后') }}
                                </span>
                            </div>

                            <div v-if="!item.completed" class="flex gap-2">
                                <!-- 专注按钮 -->
                                <button @click="openPomodoroModal(item)" class="bg-purple-100 hover:bg-purple-200 text-purple-500 hover:text-purple-700 w-8 h-8 rounded-lg flex items-center justify-center transition" title="开始专注模式">
                                    <i class="fas fa-play text-xs"></i>
                                </button>
                                
                                <button @click="openPostponeModal(item)" class="bg-slate-100 hover:bg-slate-200 text-slate-400 hover:text-indigo-500 w-8 h-8 rounded-lg flex items-center justify-center transition" title="推迟任务">
                                    <i class="fas fa-clock"></i>
                                </button>
                                
                                <button v-if="item.date <= todayStr" @click="openRateModal(item)" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-4 py-1.5 rounded-lg shadow-md shadow-indigo-200 active:scale-95 transition flex items-center gap-1">
                                    <i class="fas fa-check"></i> 打卡
                                </button>
                                <button v-else class="bg-slate-100 text-slate-400 text-xs font-bold px-4 py-1.5 rounded-lg cursor-not-allowed flex items-center gap-1 shadow-inner" title="时间未到">
                                    <i class="fas fa-lock"></i> 待解锁
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 模态框：专注番茄钟 (新增) -->
        <div v-if="pomodoroModal.show" class="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-50 flex items-center justify-center animate-fade-in">
            <div class="w-full max-w-md text-center text-white p-8">
                <!-- 准备阶段 -->
                <div v-if="!pomodoroModal.isRunning" class="scale-up">
                    <div class="mb-8">
                        <span class="inline-block px-3 py-1 rounded-full border border-indigo-400/50 bg-indigo-500/20 text-indigo-300 text-xs font-bold mb-4">
                            {{ pomodoroModal.taskItem.category }}
                        </span>
                        <h2 class="text-2xl font-bold mb-2">{{ pomodoroModal.taskItem.title }}</h2>
                        <p class="text-slate-400 text-sm">设定本次专注时长</p>
                    </div>
                    
                    <div class="flex items-center justify-center gap-6 mb-10">
                        <button @click="adjustPomodoroTime(-5)" class="w-12 h-12 rounded-full border border-slate-600 hover:border-white hover:bg-white/10 transition text-xl"><i class="fas fa-minus"></i></button>
                        <div class="text-6xl font-black tabular-nums tracking-tight">{{ pomodoroModal.duration }}<span class="text-lg font-medium text-slate-500 ml-1">m</span></div>
                        <button @click="adjustPomodoroTime(5)" class="w-12 h-12 rounded-full border border-slate-600 hover:border-white hover:bg-white/10 transition text-xl"><i class="fas fa-plus"></i></button>
                    </div>

                    <div class="flex flex-col gap-3">
                        <button @click="startPomodoro" class="bg-indigo-500 hover:bg-indigo-400 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-500/30 transition transform active:scale-95 text-lg">
                            <i class="fas fa-play mr-2"></i> 开始专注
                        </button>
                        <button @click="closePomodoroModal" class="text-slate-500 hover:text-white py-2">稍后再做</button>
                    </div>
                </div>

                <!-- 进行阶段 -->
                <div v-else class="scale-up">
                    <div class="mb-10 relative">
                        <!-- 呼吸动画圆环 -->
                        <div class="absolute inset-0 bg-indigo-500/20 rounded-full blur-3xl animate-pulse"></div>
                        <div class="relative text-8xl font-black tabular-nums tracking-tighter text-white drop-shadow-2xl">
                            {{ formatTime(pomodoroModal.timeLeft) }}
                        </div>
                        <div class="mt-4 text-indigo-300 font-medium animate-bounce-slow">正在专注中...</div>
                    </div>

                    <div class="flex justify-center gap-4">
                        <button @click="togglePomodoroPause" class="w-16 h-16 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition flex items-center justify-center text-xl">
                            <i :class="['fas', pomodoroModal.isPaused ? 'fa-play' : 'fa-pause']"></i>
                        </button>
                        <button @click="stopPomodoro" class="w-16 h-16 rounded-2xl bg-slate-800 hover:bg-red-500/20 border border-slate-700 hover:border-red-500/50 text-slate-400 hover:text-red-400 transition flex items-center justify-center text-xl">
                            <i class="fas fa-stop"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="subjectOverviewModal.show" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
            <!-- 学科总纲模态框 -->
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden scale-up flex flex-col max-h-[80vh]">
                <div class="p-6 bg-slate-800 text-white shrink-0 flex justify-between items-center">
                    <div><div class="text-xs text-slate-400 uppercase font-bold mb-1">Subject Overview</div><h2 class="text-2xl font-bold flex items-center gap-2"><span :class="['w-3 h-3 rounded-full', getCategoryColor(subjectOverviewModal.subject)]"></span> {{ subjectOverviewModal.subject }} · 月度总纲</h2></div>
                    <div class="flex items-center gap-4"><div class="flex bg-slate-700 rounded-lg p-1"><button @click="changeOverviewMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-600 transition"><i class="fas fa-chevron-left text-xs"></i></button><span class="px-3 flex items-center text-sm font-bold">{{ subjectOverviewModal.year }}年 {{ subjectOverviewModal.month + 1 }}月</span><button @click="changeOverviewMonth(1)" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-600 transition"><i class="fas fa-chevron-right text-xs"></i></button></div><button @click="subjectOverviewModal.show = false" class="text-slate-400 hover:text-white transition text-2xl leading-none">×</button></div>
                </div>
                <div class="p-6 overflow-y-auto flex-1 bg-slate-50 custom-scrollbar">
                    <div v-if="subjectMonthTasks.length === 0" class="text-center py-20 text-slate-400"><i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i><p>本月该学科暂无任务安排</p></div>
                    <div v-else class="space-y-4">
                        <div v-for="item in subjectMonthTasks" :key="item.taskId" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div class="flex-1 min-w-0 pr-4"><h4 class="font-bold text-slate-700 truncate" :title="item.title">{{ item.title }}</h4><div class="text-[10px] text-slate-400 mt-1 flex gap-2"><span v-if="item.taskType === 'weekend'" class="bg-purple-50 text-purple-500 px-1.5 rounded">连周</span><span v-else-if="item.taskType === 'onetime'" class="bg-emerald-50 text-emerald-500 px-1.5 rounded">单次</span><span v-else class="bg-indigo-50 text-indigo-500 px-1.5 rounded">周期</span><span>共 {{ item.nodes.length }} 个节点在本月</span></div></div>
                            <div class="flex gap-1.5 flex-wrap justify-end max-w-[50%]"><div v-for="(node, idx) in item.nodes" :key="idx" :class="['w-3 h-3 rounded-full border border-white shadow-sm', node.status === 'done' ? 'bg-green-500' : node.status === 'overdue' ? 'bg-red-500' : 'bg-slate-200']" :title="node.date + (node.status === 'done' ? ' (已完成)' : (node.status === 'overdue' ? ' (逾期)' : ' (待做)'))"></div></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-100 border-t border-slate-200 text-[10px] text-slate-500 flex justify-center gap-6"><div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> 已完成</div><div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-red-500"></div> 逾期未做</div><div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-slate-200"></div> 等待完成</div></div>
            </div>
        </div>

        <div v-if="showTaskModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
            <!-- 新建任务模态框 -->
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden scale-up">
                <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 class="font-bold text-lg text-slate-800">发布新学习任务</h3><button @click="showTaskModal = false" class="text-slate-400 hover:text-slate-600 text-xl">×</button></div>
                <div class="p-6 space-y-4">
                    <div class="flex bg-slate-100 p-1 rounded-xl gap-1"><button @click="newTask.type = 'ebbinghaus'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1" :class="newTask.type === 'ebbinghaus' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'"><i class="fas fa-chart-line"></i> 记忆周期</button><button @click="newTask.type = 'onetime'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1" :class="newTask.type === 'onetime' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'"><i class="fas fa-calendar-check"></i> 单次任务</button><button v-if="isWeekend(newTask.startDate)" @click="newTask.type = 'weekend'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1" :class="newTask.type === 'weekend' ? 'bg-white text-purple-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'"><i class="fas fa-sync-alt"></i> 周末连周</button></div>
                    <div v-if="newTask.type === 'weekend'" class="bg-purple-50 border border-purple-100 rounded-xl p-3 animate-fade-in"><div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-purple-700 uppercase">连续周数</label><span class="text-xs font-bold text-purple-500">{{ newTask.weekendWeeks }} 周</span></div><input type="range" v-model.number="newTask.weekendWeeks" min="1" max="12" class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer accent-purple-600"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">任务内容</label><input v-model="newTask.title" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-bold text-slate-700"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">描述/备注 (可选)</label><textarea v-model="newTask.description" rows="2" class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition text-sm text-slate-600 resize-none"></textarea></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">科目分类</label><select v-model="newTask.category" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white outline-none focus:border-indigo-500 font-medium text-sm"><option v-for="cat in categories" :value="cat">{{ cat }}</option></select></div><div><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">{{ newTask.type === 'ebbinghaus' ? '开始日期' : '执行日期' }}</label><input type="date" v-model="newTask.startDate" @change="handleDateChange" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white outline-none focus:border-indigo-500 font-medium text-slate-600 text-sm"></div></div>
                    <button @click="confirmAddTask" class="w-full text-white py-3.5 rounded-xl font-bold shadow-lg mt-2 active:scale-95 transition flex items-center justify-center gap-2" :class="[newTask.type === 'ebbinghaus' ? 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200' : newTask.type === 'onetime' ? 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200' : 'bg-purple-600 hover:bg-purple-700 shadow-purple-200']">{{ newTask.type === 'ebbinghaus' ? '启动记忆周期' : (newTask.type === 'onetime' ? '添加单次任务' : '生成连周计划') }}</button>
                </div>
            </div>
        </div>
        
        <div v-if="ratingModal.show" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
            <!-- 评价模态框 -->
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 scale-up text-center border-t-4 border-indigo-500">
                <h3 class="font-bold text-xl text-slate-800 mb-1">完成质量评价</h3>
                <p class="text-sm text-slate-500 mb-4">自我评估是提升元认知的关键</p>
                <textarea v-model="ratingModal.comment" rows="2" placeholder="心得体会：这一遍背得顺吗？(可选)" class="w-full mb-4 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500 resize-none"></textarea>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button @click="confirmRating('SSS')" class="group p-3 rounded-xl border-2 border-yellow-100 bg-yellow-50 hover:bg-yellow-100 hover:border-yellow-300 transition flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-yellow-400 text-white flex items-center justify-center font-black text-lg shadow-lg shadow-yellow-200 group-hover:scale-110 transition">S3</div><span class="text-xs font-bold text-yellow-600">完美</span></button>
                    <button @click="confirmRating('SS')" class="group p-3 rounded-xl border-2 border-purple-100 bg-purple-50 hover:bg-purple-100 hover:border-purple-300 transition flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-purple-400 text-white flex items-center justify-center font-bold text-lg shadow-lg shadow-purple-200 group-hover:scale-110 transition">S2</div><span class="text-xs font-bold text-purple-600">良好</span></button>
                    <button @click="confirmRating('S')" class="group p-3 rounded-xl border-2 border-blue-100 bg-blue-50 hover:bg-blue-100 hover:border-blue-300 transition flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-blue-400 text-white flex items-center justify-center font-bold text-lg shadow-lg shadow-blue-200 group-hover:scale-110 transition">S1</div><span class="text-xs font-bold text-blue-600">一般</span></button>
                </div>
                <button @click="ratingModal.show = false" class="text-sm text-slate-400 hover:text-slate-600 underline">取消</button>
            </div>
        </div>

        <div v-if="postponeModal.show" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
            <!-- 推迟模态框 -->
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 scale-up text-center">
                <div class="w-12 h-12 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-clock text-xl"></i></div>
                <h3 class="font-bold text-xl text-slate-800 mb-2">推迟该任务？</h3>
                <p class="text-sm text-slate-500 mb-6 px-4">如果是遗忘曲线任务，后续所有复习节点将自动顺延。</p>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button @click="confirmPostpone(1)" class="py-3 rounded-xl bg-slate-50 border border-slate-200 font-bold text-slate-700 hover:bg-indigo-50 hover:border-indigo-200 hover:text-indigo-600 transition">推迟 1 天</button>
                    <button @click="confirmPostpone(2)" class="py-3 rounded-xl bg-slate-50 border border-slate-200 font-bold text-slate-700 hover:bg-indigo-50 hover:border-indigo-200 hover:text-indigo-600 transition">推迟 2 天</button>
                </div>
                <button @click="postponeModal.show = false" class="text-sm text-slate-400 hover:text-slate-600">取消</button>
            </div>
        </div>

        <div v-if="detailModal.show && detailModal.task" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in">
            <!-- 详情模态框 -->
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden scale-up flex flex-col max-h-[90vh]">
                <div class="p-6 bg-slate-50 border-b border-slate-100 shrink-0"><div class="flex justify-between items-start mb-4"><span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold border border-indigo-200">{{ detailModal.task.category }}</span><button @click="detailModal.show = false" class="text-slate-400 hover:text-slate-600 transition text-2xl leading-none">×</button></div><div class="mb-3"><label class="block text-xs font-bold text-slate-400 uppercase mb-1">任务名称</label><input v-model="detailModal.editing.title" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-slate-800 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">描述 / 备注</label><textarea v-model="detailModal.editing.description" rows="2" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition resize-none"></textarea></div><div class="flex justify-between items-center mt-4"><button @click="deleteTask(detailModal.task.id)" class="text-red-500 hover:text-red-600 text-sm font-bold flex items-center gap-1 px-2 py-1 rounded hover:bg-red-50 transition"><i class="fas fa-trash-alt"></i> 删除任务</button><button @click="saveTaskDetails" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-indigo-200 transition">保存修改</button></div></div>
                <div class="p-6 overflow-y-auto flex-1 bg-white custom-scrollbar"><h4 class="text-xs font-bold text-slate-400 uppercase mb-4">生命周期 / 进度</h4><div class="relative pl-4 space-y-8"><div class="absolute left-6 top-2 bottom-2 w-0.5 bg-slate-100"></div><div v-for="(node, idx) in detailModal.task.schedule" :key="idx" class="relative pl-8 group"><div class="absolute left-0 top-1 w-12 flex justify-center z-10"><div class="w-4 h-4 rounded-full border-2 transition-all duration-300 flex items-center justify-center" :class="[ node.completed ? (node.quality === 'SSS' ? 'bg-yellow-400 border-yellow-200' : node.quality === 'SS' ? 'bg-purple-400 border-purple-200' : 'bg-blue-400 border-blue-200') : 'bg-white border-slate-300' ]"><i v-if="node.completed" class="fas fa-check text-[8px] text-white"></i></div></div><div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm transition group-hover:border-indigo-100"><div class="flex justify-between items-center mb-1"><div class="text-xs font-bold text-slate-500">{{ idx === 0 ? '初次学习' : `复习节点: ${node.date}` }}<span class="ml-2 font-normal text-slate-400">({{ idx === 0 ? 'Day 0' : node.interval + '天后' }})</span></div><div v-if="node.completed"><span class="text-[10px] font-black px-1.5 py-0.5 rounded" :class="{ 'bg-yellow-100 text-yellow-600': node.quality === 'SSS', 'bg-purple-100 text-purple-600': node.quality === 'SS', 'bg-blue-100 text-blue-600': node.quality === 'S' }">{{ node.quality }}</span></div><span v-else class="text-[10px] bg-slate-50 text-slate-400 px-1.5 py-0.5 rounded border border-slate-100">未开始</span></div><div v-if="node.completed && node.comment" class="mt-2 text-sm text-slate-600 bg-slate-50 p-2 rounded-lg border border-slate-100 flex gap-2"><i class="fas fa-quote-left text-slate-300 text-xs shrink-0 mt-0.5"></i><span>{{ node.comment }}</span></div></div></div></div></div>
            </div>
        </div>

    </div>

    <!-- 逻辑脚本 -->
    <script src="script.js"></script>
</body>
</html>